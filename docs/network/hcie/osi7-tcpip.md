---
title: OSI 7层模型和TCP IP 4层模型
date: 2023-01-15
isTimeLine: true
tags:
- HCIE
categories: network
---

## 一、网络模型

> OSI 7层模型

+ 应用层
+ 表示层
+ 会话层
+ 传输层  段
+ 网络层  IP地址 路由功能 包
+ 数据链路层  差错检测 mac地址 帧
+ 物理层  比特流

> TCP/IP模型

+ 应用层
+ 传输层
+ 网络层
+ 网络接口层

> 其他协议

厂商私有：

+ IPX/SPX
+ SNA

数据传输的三种形式：

+ 1、电路交换
+ 2、报文交换
    在数据之外，加上能够标识接收者以及发送者的信息
+ 3、分组交换
    依然进行报文交换，不给过将每个数据的大小进行定义

## 二、传输介质

> 同轴电缆

冲突域解决：
CSMA/CD
载波侦听多路复用/冲突检测技术

+ 先听后发
设备能够感知到所练的同轴电缆是否有电压摆动值

+ 边发边听

+ 冲突停发

+ 本地退避算法

+ 随机延迟重发

> 双绞线
传输距离：100m

双绞线的制作标准：（线序）
568A -- 白绿、绿、白橙、蓝、白蓝、橙、白棕、

+ 半双工

    类似对讲机，同时只能有一端发送数据

+ 全双工

    类似打电话，可以同一时间发送数据

> 光纤

## 三、网络通信协议

> 数据链路层与Mac地址

如果数据进行分装时，基于E2或者802.3标准，此时我们称之为以太网数据帧

局域网(以太网协议)：

+ IEEE 802.3
+ Ethernet2

广域网：

+ PPP
+ Cisco HDLC

> Ethernet2协议介绍

> 网络层

Mac地址：物理地址/网卡地址
由厂商烧录在网卡的芯片上

组成：

Mac地址由两部分组成，分别是供应商代码和序列号，其中24位代表该供应商代码，由IEEE管理和分配。剩下的24位序列号由厂商分配。

MAC地址显示16进制,48位二进制 = 12个16进制数（一个16进制可以使用4个二进制表示）

| 1      | 1 | 1     | 1    |
| :--- |:----:|---: |---: |
| 8      | 4       | 2   | 1   |

1、单播

通信形式上，点对点，单对单通信，类似于QQ私聊，数据封装时，源MAC和目的MAC都是单播的MAC，则为单播通信
单播MAC地址：从高位向地位（从左往右），第8位为0，且一定为0，其他任意

2、组播：通信形式上，点对多点，单对多的通信，类似于QQ群聊。
组播MAC地址：从高位向低位（从左往右）第8位为1，且一定为1，其他任意
数据封装时，因为组播代表的是一组的集合，面向一组的通信，此时组播mac不能成为数据的源地址，仅能充当目的地址。

### IP地址和VLSM

在 TCP/IP 通信中使用 IP 地址识别主机和路由器。 IP 地址是逻辑地址，需
要手工配置或自动获取，为了保证正常通信，每个设备必须配置 IP 地址。

IP 地址由 32 位二进制数组成。为了方便记录，将 32 位的 IP 地址分为 4
组，每 8 位为一组，每组以“ . ”隔开，再将每组数转换为十进制数。

网络号是设备所在区域的一种标识，网络号相同的设备位于同一个网段内，网络
号不同的设备通过路由器实现通信。主机号是在同一个网段中不同设备的标识，
不允许同一个网段内出现重复的主机号

8位二进制对比表：

|1000 0000|0100 0000|0010 0000|0001 0000|0000 1000|0000 0100|0000 0010|0000 0001|
|--|--|--|--|--|--|--|--|
|128|64|32|16|8|4|2|1|

ISNA机构——五大类

***A类***：A 类 IP 地址是首位以“ 0 ”开头的地址。从第 1 位到第 8 位是它的网络号，
网络号的范围是 0 ~ 127 。其中 0 和 127 属于保留地址，减去两个保留
地址，因此有 126 个可用的 A 类地址。后 24 位是主机号，一个 A 类地址的主机地址数量就是 2 的 24 次方，即16777216 个主机地址。

***B类***：B 类 IP 地址是前两位以“ 10 ”开头的地址。从第 1 位到第 16 位是它的网络
号，网络号的范围是 128.0 ~ 191.255 。其中 128.0 和 191.255 属
于保留地址，减去两个保留地址，因此有 16382 个可用的 B 类地址。其中 128.0 和 191.255 属于保留地址，减去两个保留地址，因此有 16382 个可用的 B 类地址。后 16 位是主机号，一个 B 类地址的主机地址的数量就是 2 的 16 次方，即65536 个主机地址。

***C类***：C 类 IP 地址是前三位以“ 110 ”开头的地址。从第 1 位到第 24 位是它的网
络号，网络号的范围是 192.0.0 ~ 223.255.255 。其中 192.0.0 和
223.255.255 属于保留地址，减去两个保留地址，因此有 2097150 个可用的
C 类地址。后 8 位是主机号，一个 C 类地址的主机地址的数量就是 2 的 8 次方，即
256 个主机地址。

***D类***：D 类 IP 地址是前四位以“ 1110 ”开头的地址。从第 1 位到第 32 位是它的网
络号，网络号的范围是 224.0.0.0 ~ 239.255.255.255 。D 类地址
没有主机号，用于组播。

***广播地址***:IP 地址中的主机号全部为 1 的就是广播地址，它是向同一个网段中的所有主
机发送数据包。例如一个 B 类主机地址 172.20.1.100 的广播地址是
172.20.255.255

***IP组播***:组播用于将包发送给特定组内的所有主机。组播使用 D 类地址。因此 IP 地址前四位是“ 1110 ”开头的，就是组播地址。剩下的 28 位就是组播的组编号。组播的地址范围是 224.0.0.0 ~ 239.255.255.255 ，其中 224.0.0.0 ~ 224.0.0.255 既可以在同一个网段内实现组播，又可以跨网段给全网所有组员发送组包。

|地址|网络位|主机位|网段范围|网段数量|每个网段可用主机数量|
|--|--|--|--|--|--|
|A|8|24|0-127|2^7=128-2=126|2^24-2=16,777,214|
|B|16|16|128.0 ~ 191.255|2^14=16384|2^16-2=65534|
|C|24|8|192.0.0 ~ 223.255.255 |2^21=2097152|2^8-2=254|

网段数量=2的可变的网络位的次方
主机数量=2的可变的主机位的次方-2 （剪掉网段内的一个网络地址和广播地址）

1100 0000.1010 1000.0000 0001.0110 1111地址
1111 1111.1111 1111.1111 1111.0000 0000掩码
1100 0000.1010 1000.0000 0001.0000 0000 —— 网络地址（出现在路由表）192.168.1.0
1100 0000.1010 1000.0000 0001.0000 0000 —— 广播地址（用于本网段所有主机通信）192.168.1.255

> VLSM——可变长子网掩码

网络位向主机位进行借位，增加网段，减少网络广播，增加网络隔离

193.1.1.0/24

193.1.1.0/25

1100 0001.0000 0001.0000 0001.0000 0000 网络地址 193.1.1.0/24

1100 0001.0000 0001.0000 0001.1111 1111 广播地址 193.1.1.255/24

1111 1111.1111 1111.1111 1111.0000 0000 子网掩码

可用地址范围：`193.1.1.1-193.1.1.254    2^8 -2 =254`

借一位主机位情况：

主机位为0：

1100 0001.0000 0001.0000 0001.`0`000 0000 网络地址 193.1.1.0/25

1100 0001.0000 0001.0000 0001.`0`111 1111 广播地址 193.1.1.127/25

1111 1111.1111 1111.1111 1111.`1`000 0000 子网掩码 255.255.255.128

可用地址范围：`193.1.1.1-193.1.1.126    2^7 -2 =126`

主机位为1：

1100 0001.0000 0001.0000 0001.`1`000 0000 网络地址 193.1.1.128/25

1100 0001.0000 0001.0000 0001.`1`111 1111 广播地址 193.1.1.255/25

1111 1111.1111 1111.1111 1111.`1`000 0000 子网掩码 255.255.255.128

可用地址范围：`193.1.1.129-193.1.1.254    2^7 -2 =126`

测试：

网段： 194.2.3.0/24 —— 分配給不同的部门（4个部门）

|部门|人数|地址|
|--|--|--|
|项目部|58人|地址:194.2.3.128/26|
|研发部|100人|地址:194.2.3.0/25|
|市场部|27人|地址:194.2.3.128/27|
|财务部|15人|地址:194.2.3.224/27|

分配原则：

+ 1、先求最大值，先求一个子网，该子网满足数量最多的情况
+ 2、一旦分配出去的地址，不能再给别人使用

前半部分给研发部：

2^x-2>=100 x=7=主机位

---

1100 0100.0000 0010.0000 0011.`0`000 0000

194.2.3.0/25（194.2.3.0-194.2.3.127）研发部（126个可用IP）

---

1100 0100.0000 0010.0000 0011.1`0`00 0000

194.2.3.128/26: 194.2.3.128 - 194.2.3.191 (项目部:62个可用IP)

---

1100 0100.0000 0010.0000 0011.11`0`0 0000

194.2.3.128/27: 194.2.3.192 - 194.2.3.223 (市场部：30个可用IP)

---

1100 0100.0000 0010.0000 0011.11`1`0 0000

194.2.3.224/27: 194.2.3.224 - 194.2.3.255 (财务部：30个可用IP)

---

> CIDR——无类域间路由

将多个小的子网，用一个相对更大的地址范围进行概括，以此来实现表项优化
CIDR增加了网络的可扩展性。

10.1.0.0/24
10.1.1.0/24
10.1.2.0/24
10.1.3.0/24

1、将子网转换为2进制：
0000 1010.0000 0001.0000 0000.0000 0000 ------ 10.1.0.0

0000 1010.0000 0001.0000 0001.0000 0000 ------ 10.1.1.0

0000 1010.0000 0001.0000 0010.0000 0000 ------ 10.1.2.0

0000 1010.0000 0001.0000 0011.0000 0000 ------ 10.1.3.0
2、自高位向低位进行对比，位数相同原封不动取值，一旦不同，停止对比行为，后方全部取值为0，即便后面还有相同位数。

0000 1010.0000 0001.0000 0000.0000 0000 ------ 10.1.0.0

0000 1010.0000 0001.0000 0001.0000 0000 ------ 10.1.1.0

0000 1010.0000 0001.0000 0010.0000 0000 ------ 10.1.2.0

0000 1010.0000 0001.0000 0011.0000 0000 ------ 10.1.3.0

`0000 1010.0000 0001.0000 00`00.0000 0000

3、将相同位数取值完毕，转换为十进制，将相同位数取值为掩码缩写的前缀

`0000 1010.0000 0001.0000 00`00.0000 0000 --- 10.1.0.0/22 -> 255.255.252.0

4、测试，再加一个网段

10.1.0.0/24
10.1.1.0/24
10.1.2.0/24
10.1.3.0/24
10.1.4.0/24

`0000 1010.0000 0001.0000 0000`.0000 0000 ------ 10.1.0.0

0000 1010.0000 0001.0000 0001.0000 0000 ------ 10.1.1.0

0000 1010.0000 0001.0000 0010.0000 0000 ------ 10.1.2.0

0000 1010.0000 0001.0000 0011.0000 0000 ------ 10.1.3.0

0000 1010.0000 0001.0000 0100.0000 0000 ------ 10.1.4.0

`0000 1010.0000 0001.0000 0`000.0000 0000 ---- 10.1.0.0/21  ---- 网络地址

`0000 1010.0000 0001.0000 0`111.1111 1111 ---- 10.1.7.255/21 ---- 广播地址

可用地址范围： 10.1.0.1 --- 10.1.7.254

最优：

10.1.1.0/22 --- 上边四条
10.1.4.0/24 --- 最下面一条

> CIDR和VLSM区别

CIDR 是主机号向网络号借位，目的是把几个网络汇总成一个大的网络，增加子网主机数量；

VLSM 是网络号向主机号借位，目的是把一个标准的网络划分成几个子网，减少子网主机数量。

VLSM是在私网（内网）内优化网络划分，CIDR是在路由器进行对外路由通告时用到，二者不冲突。

> 公网和私网

IP 地址分为公网地址和私有地址。公网地址是在互联网上使用的，私有地址是在局域网中使用的。
公网地址由 Internet NIC 负责分配，通过它直接访问互联网

> 网关

同网段通信时是可以直接通信的。
跨网段通信时是不可以直接通信的。

192.168.1.1/25 ------ping通------- 192.168.1.2/26

0000 0001

1000 0000

1000 0000

可以发包，也可以收到包

1、通信时，发送端的主机会使用对方的IP地址+自己的掩码进行计算，算出对方的网络地址
2、计算之后，将对方的网络地址和自己的网络地址进行对比，相同，则认为在同一个网段，不相同，则不在同一个网段，返回段也是。

192.168.1.1/25  ---------ping不通------ 192.168.1.5/30
可以发包，收不到包

网关用来转发来自不通网段之间的数据包。网关设备上连接本地网段的接口地址即为 ***该网段的网关地址***。当前网络设备的下一跳地址。

***网关地址***是一个配置在某个设备接口上的地址。

***网关设备***可以是路由器，三层交换机，防火墙。

> ICMP协议

ICMP一般被称为3.5层协议，归类于网络层协议，但封装IP Header之上，protocol = 1

ICMP应用：

+ ping
+ tracert

> ARP协议

广播域：广播报文
       交换机所有端口在同一个广播域（不划分VLAN）
       路由器一个接口是一个广播域

DARP和定向ARP

ARP代理
免费ARP

### TCP

连接：正式发送数据前需要进行握手(一种虚拟的”点到点“的连接=单播的模式)

三次握手建立连接：

+ -> (SYN,ACK,seq=a)
+ <- (SYN,ACK,seq=b,ack=a+1)
+ -> (ACK,seq=a+1,ack=b+1)

四次挥手关闭连接：

数据全部发送完毕，才能断开连接

+ -> (FIN,ACK,seq=a,ack=b)
+ <- (ACK,seq=b,ack=a+1)
+ <- (FIN,ACK,seq=b,ack=a+1)
+ -> (ACK,seq=a+1,ack=b+1)

确认机制

+ 通过报文标志位确认

有序机制

+ 提前分片排序
重传机制：

+ 确认重传
+ 超时重传 （RTTS 加权的平均往返时间）

流量控制：TCP协议中的Window控制，滑动窗口算法

---

E2 | IPV4 | TCP | HTTP

---

***MTU***是数据链路层的***最大传输单元***，默认最大1500字节，可修改

***MSS***是应用层的***最大报文段长度***，默认默认1460字节，可修改

ipv4头部最小20个字节，tcp头部最小20个字节，所以1500 - （3，4层头部头部长度） = 1460

> UDP

使用UDP传输数据时，由应用程序根据需要提供报文到达确认、排序、流量控制等功能

## 五、设备与路由

> VRP系统介绍

<https://zhuanlan.zhihu.com/p/180214934>

命令：

```cmd
system-view/sy:  进入系统视图
q/quit:  从当前视图退回倒上一个视图
ctrl+z:  从当前视图退回到用户视图
interface 接口名称: 进入到接口视图,如 interface GigabitEthernet 0/0/0
ospf/其他协议：进入到协议视图，如： opsf 10
sysname/sy: 命名设备，在系统视图下，如：sy r1
```

命令等级：

|用户等级|命令等级|名称|
|--|--|--|
|0|0|访问级|
|1|0 and 1|监控级|
|2|0,1 and 2|配置级|
|3-15|0,1,2 and 3|管理级|

```shell
# 无用户模式
[AR1-ui-vty0-4]authentication-mode password 
Please configure the login password (maximum length 16):duidui2
# 配置命令等级为3
[AR1-ui-vty0-4]user privilege level 3
```

3A：认证，授权，审计/计费

> 路由介绍

路由表： 路由器寻址转发时查询路由表。根据路由进行具体的转发。

```shell
# 进入系统模式
<Huawei>sy
Enter system view, return user view with Ctrl+Z.
# 显示路由表
[Huawei]display ip routing-table 
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: Public
         Destinations : 4        Routes : 4        

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

      127.0.0.0/8   Direct  0    0           D   127.0.0.1       InLoopBack0
      127.0.0.1/32  Direct  0    0           D   127.0.0.1       InLoopBack0
127.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0
255.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0

[Huawei]
```

+ 网段路由（掩码小于32）
+ 主机路由（掩码等于32），标识一个精确的IP地址

路由表默认有四条默认路由：

+ 127.0.0.0/8
+ 127.0.0.1/32
+ 127.255.255.255/32
+ 255.255.255.255/32

路由表的形成：

+ 直连路由（某一个主机配置IP之后会多出三条直连路由）
  + 主机路由
  + 广播路由
  + 网段路由
+ 静态路由
+ 动态路由

主机配置IP之后，物理接口关闭，直连路由就会消失，物理接口开启，直连路由就会存在(模拟拔网线)

```shell
[Huawei]dis ip routing-table
Route Flags: R - relay, D - download to fib
------------------------------------------------------------------------------
Routing Tables: Public
         Destinations : 4        Routes : 4        

Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface

      127.0.0.0/8   Direct  0    0           D   127.0.0.1       InLoopBack0
      127.0.0.1/32  Direct  0    0           D   127.0.0.1       InLoopBack0
127.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0
255.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0

[Huawei]in g0/0/0
[Huawei-GigabitEthernet0/0/0]dis ip in br
*down: administratively down
^down: standby
(l): loopback
(s): spoofing
The number of interface that is UP in Physical is 3
The number of interface that is DOWN in Physical is 1
The number of interface that is UP in Protocol is 1
The number of interface that is DOWN in Protocol is 3

Interface                         IP Address/Mask      Physical   Protocol  
GigabitEthernet0/0/0              unassigned           up         down      
GigabitEthernet0/0/1              unassigned           up         down      
GigabitEthernet0/0/2              unassigned           down       down      
NULL0                             unassigned           up         up(s)     
[Huawei-GigabitEthernet0/0/0]shutdown
Jan 24 2023 00:39:53-08:00 Huawei %%01IFPDT/4/IF_STATE(l)[0]:Interface GigabitEt
hernet0/0/0 has turned into DOWN state.
```

路由匹配原则：最长掩码匹配原则
